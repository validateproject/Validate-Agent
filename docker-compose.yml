services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  agent:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      redis:
        condition: service_healthy
      validator1:
        condition: service_started
      validator2:
        condition: service_started
    volumes:
      - ./config.docker.toml:/app/config.toml:ro
    environment:
      - RUST_LOG=info
      - EXECUTOR_SERVER_ADDR=http://executor:50051
    command: ["/usr/local/bin/agent"]
    ports:
      - "3000:3000"

  metrics_collector:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      redis:
        condition: service_healthy
      validator1:
        condition: service_started
      validator2:
        condition: service_started
    volumes:
      - ./config.docker.toml:/app/config.toml:ro
    environment:
      - RUST_LOG=info
      - EXECUTOR_SERVER_ADDR=http://executor:50051
    command: ["/usr/local/bin/metrics_collector"]

  executor:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      redis:
        condition: service_healthy
      validator1:
        condition: service_started
      validator2:
        condition: service_started
    volumes:
      - ./config.docker.toml:/app/config.toml:ro
    environment:
      - RUST_LOG=info
    command: ["/usr/local/bin/executor_daemon"]

  validator_client1:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      executor:
        condition: service_started
      validator1:
        condition: service_started
    environment:
      - RUST_LOG=info
      - EXECUTOR_SERVER_ADDR=http://executor:50051
      - VALIDATOR_ID=validator-local-1
      - VALIDATOR_AUTH_TOKEN=validator-local-1-secret
      - VALIDATOR_METRICS_URL=http://validator1.local:9100/metrics
    command: ["/usr/local/bin/validator_client"]

  validator_client2:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      executor:
        condition: service_started
      validator2:
        condition: service_started
    environment:
      - RUST_LOG=info
      - EXECUTOR_SERVER_ADDR=http://executor:50051
      - VALIDATOR_ID=validator-local-2
      - VALIDATOR_AUTH_TOKEN=validator-local-2-secret
      - VALIDATOR_METRICS_URL=http://validator2.local:9100/metrics
    command: ["/usr/local/bin/validator_client"]

  dashboard:
    image: node:20-alpine
    working_dir: /workspace/dashboard
    depends_on:
      agent:
        condition: service_started
    environment:
      - VITE_AGENT_API=http://localhost:3000
      - CHOKIDAR_USEPOLLING=1
    command: >
      sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 5173"
    volumes:
      - .:/workspace
    ports:
      - "5173:5173"

  validator1:
    image: python:3.12-alpine
    hostname: validator1.local
    volumes:
      - ./docker/validator-mock:/opt/validator-mock:ro
    working_dir: /opt/validator-mock
    environment:
      - VALIDATOR_ID=validator-local-1
    command: ["python", "server.py"]
    ports:
      - "9101:9100"
    networks:
      default:
        aliases:
          - validator1.local

  validator2:
    image: python:3.12-alpine
    hostname: validator2.local
    volumes:
      - ./docker/validator-mock:/opt/validator-mock:ro
    working_dir: /opt/validator-mock
    environment:
      - VALIDATOR_ID=validator-local-2
    command: ["python", "server.py"]
    ports:
      - "9102:9100"
    networks:
      default:
        aliases:
          - validator2.local

  tests:
    image: rust:1.84-bookworm
    working_dir: /workspace
    environment:
      - CARGO_TARGET_DIR=/workspace/target
    volumes:
      - .:/workspace:delegated
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/workspace/target
    command: ["cargo", "test", "--workspace"]

volumes:
  cargo-cache:
  target-cache:

